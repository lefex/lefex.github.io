(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{571:function(s,e,n){"use strict";n.r(e);var a=n(48),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"xmlhttprequest"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#xmlhttprequest"}},[s._v("#")]),s._v(" XMLHTTPRequest")]),s._v(" "),n("p",[s._v("在前端发展初期，页面中的数据只能整体刷新，当想改变网页某些局部内容时，必须重新刷新，这体验太糟糕了！")]),s._v(" "),n("p",[s._v("在 2005 年的时候，Jesse James Garrett 发布了一篇标题为“Ajax：A New Approach to Web Application” 的文章，这项技术改变了网页只能够全部刷新的局面。")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("SYHybridWebView")]),s._v(" 中我注册了 2 个 messaghandler：")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// deal with environment message\n[self.configuration.userContentController addScriptMessageHandler:self name:kSYScriptEnvMsgName];\n// deal with common message\n[self.configuration.userContentController addScriptMessageHandler:self.msgHandler name:kSYScriptMsgName];\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("由于 userContentController 会持有 self， configuration 持有 userContentController，configuration 又被 self 持有，导致 self 持有 self，出现了循环引用。")]),s._v(" "),n("p",[s._v("想解决这个问题，需要调用 "),n("code",[s._v("removeScriptMessageHandlerForName")]),s._v("，在哪里调用这个方法合适呢？")]),s._v(" "),n("p",[s._v("想到 "),n("code",[s._v("SYHybridWebView")]),s._v(" 只是一个 view，可以通过 UIView 的生命周期来解决：")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 视图被添加\n- (void)didAddSubview:(UIView *)subview {\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// 当视图即将加入父视图时 / 当视图即将从父视图移除时调用\n- (void)willMoveToSuperview:(nullable UIView *)newSuperview {\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// 当视图加入父视图时 / 当视图从父视图移除时调用\n- (void)didMoveToSuperview {\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// 当视图即将加入window视图时 / 当视图即将从window视图移除时调用\n- (void)willMoveToWindow:(nullable UIWindow *)newWindow {\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// - 当视图加入window视图时 / 当视图从window视图移除时调用\n- (void)didMoveToWindow {\n   NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// 当子视图从本视图移除时调用\n- (void)willRemoveSubview:(UIView *)subview {\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("但是由于 "),n("code",[s._v("SYHybridWebView")]),s._v(" 并没有被释放，"),n("code",[s._v("willRemoveSubview:")]),s._v(" 这个方法并不会调用，我们看一下 View 声明周期的调用顺序：")]),s._v(" "),n("p",[n("code",[s._v("SYHybridWebView")]),s._v(" 被添加到视图上时的调用顺序：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 09:58:01.167321+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35982")]),s._v(":33187169"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" didAddSubview:\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 09:58:01.207589+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35982")]),s._v(":33187169"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" willMoveToSuperview:\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 09:58:01.207742+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35982")]),s._v(":33187169"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" didMoveToSuperview\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 09:58:01.213926+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35982")]),s._v(":33187169"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" willMoveToWindow:\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 09:58:01.216857+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("35982")]),s._v(":33187169"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" didMoveToWindow\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[n("code",[s._v("SYHybridWebView")]),s._v(" 从视图中移除时的调用顺序：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":02:42.963931+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36066")]),s._v(":33201308"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" willMoveToWindow:\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":02:42.964358+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36066")]),s._v(":33201308"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" didMoveToWindow\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":02:42.964887+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36066")]),s._v(":33201308"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" willMoveToSuperview:\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-10-25 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":02:42.965007+0800 公众号素燕"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("36066")]),s._v(":33201308"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" didMoveToSuperview\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("从上面的方法调用顺序上来看，"),n("code",[s._v("SYHybridWebView")]),s._v("  在被添加到视图和从视图移除时都会调用 "),n("code",[s._v("willMoveToSuperview")]),s._v("，我们看下这个方法的官方解释：")]),s._v(" "),n("ul",[n("li",[s._v("Summary")])]),s._v(" "),n("p",[s._v("Tells the view that its superview is about to change to the specified superview.")]),s._v(" "),n("ul",[n("li",[s._v("Discussion")])]),s._v(" "),n("p",[s._v("The default implementation of this method does nothing. Subclasses can override it to perform additional actions whenever the superview changes.")]),s._v(" "),n("p",[s._v("大体意思说，当这个 view 的父视图发生变化时都会调用这个方法。那我们想到一种方案。添加一个标记为来区分调用 "),n("code",[s._v("willMoveToSuperview：")]),s._v(" 是 add 还是 remove，当 remove 的时候，调用 "),n("code",[s._v("removeScriptMessageHandlerForName")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 视图被添加\n- (void)didAddSubview:(UIView *)subview {\n    [super didAddSubview:subview];\n    self.isAdd = YES;\n    NSLog(@"%@", NSStringFromSelector(_cmd));\n}\n\n// 当视图即将加入父视图时 / 当视图即将从父视图移除时调用\n- (void)willMoveToSuperview:(nullable UIView *)newSuperview {\n    [super willMoveToSuperview:newSuperview];\n    if (!self.isAdd) {\n        [self syDestoryed];\n    }\n    self.isAdd = NO;\n    NSLog(@"%@ - %@", NSStringFromSelector(_cmd), newSuperview);\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("但这种方式有弊端，很大的弊端，你要保证 "),n("code",[s._v("SYHybridWebView")]),s._v(" 一旦被添加到视图上，就不能改变它的父视图了。所有这个方法一时爽，后面维护的人火葬场。")]),s._v(" "),n("h2",{attrs:{id:"继续思考-方案二"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#继续思考-方案二"}},[s._v("#")]),s._v(" 继续思考，方案二")]),s._v(" "),n("p",[s._v("思考一个问题，webview 啥时候不用了，ViewController 可以知道，直接在 ViewController 被释放是调用 "),n("code",[s._v("removeScriptMessageHandlerForName")]),s._v("，那么我对外提供一个方法：")]),s._v(" "),n("div",{staticClass:"language-objc line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-objc"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("syDestoryed "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("configuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userContentController removeScriptMessageHandlerForName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kSYScriptEnvMsgName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("configuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userContentController removeScriptMessageHandlerForName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kSYScriptMsgName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("在 "),n("code",[s._v("SYHybridWebViewController")]),s._v(" 的 dealloc 方法中调用：")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- (void)dealloc {\n   [_webview syDestoryed];\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这很好解决了内容泄露的问题。但是如果有人并没有使用 "),n("code",[s._v("SYHybridWebViewController")]),s._v(" ，而直接用了 "),n("code",[s._v("SYHybridWebView")]),s._v("，忘记调用了 "),n("code",[s._v("syDestoryed")]),s._v("，那就引发了内存泄露，开发者肯定会说：”看看你写的是啥了，都有内存泄露了“。")]),s._v(" "),n("p",[s._v("我呵呵回答道：”你在 ViewController 的 dealloc 方法中调用下 "),n("code",[s._v("syDestoryed")]),s._v(" 这个方法。“")]),s._v(" "),n("p",[s._v("开发者：”真坑！！！“")]),s._v(" "),n("h2",{attrs:{id:"探索更优方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#探索更优方案"}},[s._v("#")]),s._v(" 探索更优方案")]),s._v(" "),n("p",[s._v("上面二个方案都能解决问题，但是并不好。那再回到这个方法：")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- (void)willMoveToSuperview:(nullable UIView *)newSuperview {\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("如果 ViewController 释放后，"),n("code",[s._v("SYHybridWebView")]),s._v(" 发生内存泄露，调用 "),n("code",[s._v("willMoveToSuperview:")]),s._v(" 这个方法的参数 newSuperview 值是啥 ？")]),s._v(" "),n("p",[s._v("答案是 null，因为 ViewController 释放后，newSuperview 就不存在了，那么我在 newSuperview 为空时调用 syDestoryed 方法不就可以了吗。")]),s._v(" "),n("div",{staticClass:"language-objective-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- (void)willMoveToSuperview:(nullable UIView *)newSuperview {\n    [super willMoveToSuperview:newSuperview];\n    if (!newSuperview) {\n         [self syDestoryed];\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("综上，我认为这是最优解！如果最优解恰好不能满足你的需求，你可以使用方式二，在 webview 不使用的使用，主动调用下 "),n("code",[s._v("syDestoryed")]),s._v(" 方法。")]),s._v(" "),n("h2",{attrs:{id:"最优解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最优解"}},[s._v("#")]),s._v(" 最优解")]),s._v(" "),n("p",[s._v("昨天关于内存泄露的问题，我自认为是最优解，没想到打脸了。当我发完文章后，有人提出了一种更好的解法。今天再总结一下，感谢各位提出更好的方案。")]),s._v(" "),n("p",[s._v("回顾一下发生内存泄露的根本原因是 "),n("code",[s._v("SYHybridWebView")]),s._v(" 持有了 "),n("code",[s._v("SYMessageHandler")]),s._v(" 这个类的实例，之所以要持有它，是因为自定义插件最终要注册到 "),n("code",[s._v("SYMessageHandler")]),s._v(" 这个类的实例中。如果我这样写，就不会产生内存泄露：")]),s._v(" "),n("div",{staticClass:"language-objc line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-objc"}},[n("code",[s._v("SYMessageHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("messageHandler "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SYMessageHandler alloc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" init"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("configuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userContentController addScriptMessageHandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("messageHandler name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kSYScriptMsgName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("最终解决方案是添加一个 weak proxy，写法如下：")]),s._v(" "),n("div",{staticClass:"language-objc line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-objc"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("configuration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userContentController addScriptMessageHandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("WKScriptMessageHandler"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("SYWeakProxy proxyWithTarget"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("self")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("msgHandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kSYScriptMsgName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("社区中基本都参考 YYWeakProxy 的写法，我也不例外直接使用了它。")])])}),[],!1,null,null,null);e.default=t.exports}}]);